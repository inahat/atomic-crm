name: Scheduled DB Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Every day at 02:00 UTC
  workflow_dispatch: {}  # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    
    env:
      BACKUP_DIR: ./backups
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create backup directory
        run: mkdir -p $BACKUP_DIR

      - name: Create database backup
        run: |
          TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
          FILENAME="backup-${TIMESTAMP}.dump"
          ENCRYPTED_NAME="${FILENAME}.enc"
          
          # Use session pooler for IPv4 compatibility
          POOLER_URL="postgresql://${PGUSER}:${PGPASSWORD}@aws-0-eu-west-1.pooler.supabase.com:5432/postgres"
          
          echo "Creating backup: $FILENAME"
          pg_dump -Fc --file="${BACKUP_DIR}/${FILENAME}" "$POOLER_URL"
          
          echo "Encrypting backup: $ENCRYPTED_NAME"
          openssl enc -aes-256-cbc -salt -pbkdf2 -pass env:BACKUP_PASSPHRASE \
            -in "${BACKUP_DIR}/${FILENAME}" \
            -out "${BACKUP_DIR}/${ENCRYPTED_NAME}"
          
          # Remove unencrypted file
          rm "${BACKUP_DIR}/${FILENAME}"
          
          echo "Backup completed: $ENCRYPTED_NAME"
          ls -lh "${BACKUP_DIR}/${ENCRYPTED_NAME}"
        env:
          PGUSER: postgres
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          BACKUP_PASSPHRASE: ${{ secrets.BACKUP_PASSPHRASE }}

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: backups/*.enc
          retention-days: 90  # Maximum retention

      - name: Backup summary
        if: success()
        run: |
          echo "### Database Backup Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Backup completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** AtomicCRM (bxosgtiwjkpuguyggicm)" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** GitHub Artifacts (90 days)" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from: Actions → This workflow run → Artifacts" >> $GITHUB_STEP_SUMMARY
