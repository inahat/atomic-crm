name: Scheduled DB Backup

on:
  schedule:
    - cron: '0 3 * * *' # runs daily at 03:00 UTC by default; change as needed
  workflow_dispatch: {} # allows manual run

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      BACKUP_DIR: ./backups
      RETENTION_COUNT: '14'
      S3_REGION: 'us-east-1'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies (awscli, pg tools)
        run: |
          # Add PostgreSQL 17 Repo
          sudo install -d /usr/share/postgresql-common/pgdg
          sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
          sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 openssl python3 python3-pip
          pip3 install --upgrade awscli

      - name: Verify pg_dump version
        run: |
          echo "Default pg_dump version:"
          pg_dump --version
          
          echo "Postgres 17 pg_dump version:"
          /usr/lib/postgresql/17/bin/pg_dump --version

      # Corrected step: Use project-qualified username format (postgres.PROJECT_REF)
      # User verified this works with correct password
      - name: Create Database Backup
        env:
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
        run: |
          echo "Create backup directory..."
          mkdir -p backups
          
          TIMESTAMP=$(date +%Y%m%dT%H%M%SZ)
          BACKUP_NAME="backup-${TIMESTAMP}.dump"
          
          echo "Starting pg_dump (explicit v17 binary)..."
          # Connection string uses project-qualified username
          # Explicitly use v17 binary to match server version 17.6
          /usr/lib/postgresql/17/bin/pg_dump "postgres://postgres.bxosgtiwjkpuguyggicm@aws-1-eu-west-1.pooler.supabase.com:5432/postgres?sslmode=require" \
            --format=custom \
            --file="backups/${BACKUP_NAME}" \
            --no-owner \
            --no-privileges \
            --verbose
            
          echo "Backup created: backups/${BACKUP_NAME}"
          ls -lh backups/${BACKUP_NAME}

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.sha }}
          path: backups/*.dump
          retention-days: 30
